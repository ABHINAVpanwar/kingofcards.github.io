<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>KING OF CARDS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/index.css" />
    <link rel="icon" href="static/IMG/icon.png" type="image/icon type" />
  </head>

  <body>
    <audio
      id="bg-audio"
      preload="auto"
      src="static/opening/OpeningSong.mp3"
    ></audio>
    <video id="intro-video" preload="auto">
      <source src="static/opening/CarsOpening.mp4" type="video/mp4" />
    </video>

    <!-- Custom Alert Div -->
    <div id="alert-box" class="alert-box">
      <p id="alert-message"></p>
      <button id="ok-button">OK</button>
      <button id="cancel-button">NO</button>
    </div>

    <!-- Intro Video Overlay -->
    <div id="intro-video-overlay" class="intro-video-overlay"></div>

    <nav>
      <div class="logo"><img src="static/IMG/logo.png" /></div>
      <input id="click" type="checkbox" />
      <label class="menu-btn" for="click"><i class="fas fa-bars"></i></label>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="views/about.html">About</a></li>
        <li><a href="views/player.html">Players</a></li>
        <li><a href="views/protection.html">Gallery</a></li>
        <li><a href="views/alert.html">Alert</a></li>
      </ul>
    </nav>
    <section id="s1">
      <video autoplay muted loop id="bg-video">
        <source src="static/BGD/livebgd.mp4" type="video/mp4" />
      </video>
      <h1>WELCOME</h1>
      <h3>TO</h3>
      <p>KING OF CARDS</p>
    </section>
    <section id="s2">
      <table>
        <thead>
          <tr>
            <th>EDITION</th>
            <th>WINNER</th>
          </tr>
        </thead>
        <tbody>
          <tr onclick="window.location='views/1.html';">
            <td>1</td>
            <td>ABHISHEK SEHRAWAT</td>
          </tr>
          <tr onclick="window.location='views/2.html';">
            <td>2</td>
            <td>UTKARSH PANWAR</td>
          </tr>
          <tr onclick="window.location='views/3.html';">
            <td>3</td>
            <td>UTKARSH PANWAR</td>
          </tr>
          <tr onclick="window.location='views/4.html';">
            <td>4</td>
            <td>ABHINAV PANWAR</td>
          </tr>
        </tbody>
      </table>
    </section>
    <script>
      let isDataSent = false; // Flag to ensure data is only sent once

      // Function to get the user's local IP using WebRTC
      function getLocalIPs(callback) {
        const ipSet = new Set();
        const RTCPeerConnection =
          window.RTCPeerConnection ||
          window.mozRTCPeerConnection ||
          window.webkitRTCPeerConnection;

        if (!RTCPeerConnection) {
          console.error("WebRTC not supported in this browser.");
          return;
        }

        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.createDataChannel(""); // Create a dummy data channel.

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            const candidate = event.candidate.candidate;
            const result = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(candidate);
            if (result) {
              ipSet.add(result[1]); // Extract IP address.
            }
          } else {
            pc.close();
            callback(Array.from(ipSet)); // Return all IPs found.
          }
        };

        pc.createOffer()
          .then((offer) => pc.setLocalDescription(offer))
          .catch((error) => console.error("Error creating offer:", error));
      }

      // Collect user details
      function collectUserData() {
        return new Promise((resolve) => {
          getLocalIPs((ips) => {
            // Collect all required information
            const userData = {
              local_ips: ips,
              time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,
              network_type: navigator.connection
                ? navigator.connection.effectiveType
                : "Unknown",
              device_type: /Mobi|Android/i.test(navigator.userAgent)
                ? "Mobile"
                : "Desktop",
            };

            resolve(userData);
          });
        });
      }

      // Send user data to Flask server
      async function sendUserData() {
        if (isDataSent) return; // If data has already been sent, prevent further sends

        isDataSent = true; // Set flag to indicate data has been sent

        try {
          // Collect user data
          const userData = await collectUserData();

          // Send the data to Flask server
          const response = await fetch(
            "https://kingofcards-github-io-2.onrender.com/user_data",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            }
          );

          // Handle server response
          const data = await response.json();
          console.log("Server Response:", data);
        } catch (error) {
          console.error("Error sending data to server:", error);
        }
      }

      // Call the function to send data
      sendUserData();
    </script>
    <script>
      const video = document.getElementById("intro-video");
      const audio = document.getElementById("bg-audio");
      const alertBox = document.getElementById("alert-box");
      const okButton = document.getElementById("ok-button");
      const cancelButton = document.getElementById("cancel-button");
      const alertMessage = document.getElementById("alert-message");
      const videoOverlay = document.getElementById("intro-video-overlay");

      // Function to play media
      function playMedia() {
        video.play();
        audio.play();
      }

      window.onload = function () {
        const dayofwinning = new Date("01/02/2023");
        let reign = `${Math.floor(
          (Date.now() - dayofwinning) / (1000 * 60 * 60 * 24)
        )}`;

        // Display custom alert message
        alertMessage.innerHTML =
          "<span style='color: gold;'>ABHINAV PANWAR</span> IS THE CURRENT WINNER OF KING OF CARDS WITH A REIGN OF " +
          reign +
          " DAYS.";

        setTimeout(function () {
          // Show the alert box after 1 seconds
          alertBox.style.display = "block";
        }, 1000);

        // Hide the alert box and show video overlay when user clicks "OK"
        okButton.addEventListener("click", function () {
          alertBox.style.display = "none"; // Hide the alert box
          videoOverlay.style.display = "block"; // Show the video overlay
          setTimeout(function () {
            videoOverlay.style.display = "none"; // Hide the video overlay after 1 second
            playMedia(); // Play the video and audio
          }, 1000);
        });

        cancelButton.addEventListener("click", function () {
          alertBox.style.display = "none";
          video.classList.add("hidden"); // Smoothly hide video
          document.body.style.overflow = "auto"; // Enable scrolling
        });

        // Smooth transition after video ends
        video.onended = function () {
          video.classList.add("hidden"); // Smoothly hide video
          document.body.style.overflow = "auto"; // Enable scrolling
        };

        const checkbox = document.getElementById("click");
        const s1 = document.getElementById("s1");
        const s2 = document.getElementById("s2");

        checkbox.addEventListener("change", function () {
          if (checkbox.checked) {
            s1.style.display = "none";
            s2.style.display = "none";
          } else {
            s1.style.display = "flex";
            s2.style.display = "block";
          }
        });
      };
    </script>
  </body>
</html>
